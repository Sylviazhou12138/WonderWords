// content.js - ä¼˜åŒ–ç‰ˆæœ¬

console.log("ğŸš€ WonderWords: Enhanced Version Loaded");

// --- 1. ä½¿ç”¨ MutationObserver ä»£æ›¿ setInterval ---
let observer = null;

function injectButton() {
  const owner = document.querySelector("#owner");
  if (owner && !document.getElementById("wonderwords-btn")) {
    const btn = document.createElement("button");
    btn.id = "wonderwords-btn";
    btn.textContent = "âœ¨ Analyze Words";
    btn.style.cssText =
      "background-color: #3ea6ff; color: black; border: none; padding: 8px 16px; margin-left: 10px; border-radius: 18px; font-weight: bold; cursor: pointer; font-family: Roboto, Arial;";

    btn.onclick = startProcess;
    owner.appendChild(btn);
    console.log("âœ… Button injected successfully");
  }
}

// ä½¿ç”¨ MutationObserver ç›‘å¬é¡µé¢å˜åŒ–ï¼ˆé¿å…å®šæ—¶å™¨æ±¡æŸ“ï¼‰
function initObserver() {
  if (observer) observer.disconnect();

  observer = new MutationObserver(() => {
    injectButton();
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
  });

  injectButton(); // ç«‹å³å°è¯•æ³¨å…¥ä¸€æ¬¡
}

// é¡µé¢åŠ è½½æ—¶å¯åŠ¨
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initObserver);
} else {
  initObserver();
}

// --- 2. ä¸»æµç¨‹ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰---
async function startProcess() {
  const btn = document.getElementById("wonderwords-btn");
  const originalText = btn.textContent;

  try {
    btn.textContent = "ğŸ“¥ è·å–å­—å¹•...";
    btn.disabled = true;

    // ç¬¬ä¸€æ­¥ï¼šè·å–æ–‡å­—
    const text = await tryGetSubtitles();

    console.log("ğŸ“ æœ€ç»ˆè·å–çš„æ–‡æœ¬é•¿åº¦:", text?.length);
    console.log("ğŸ“ æ–‡æœ¬é¢„è§ˆ:", text?.slice(0, 200));

    if (!text || text.length < 30) {
      throw new Error(`å­—å¹•å†…å®¹è¿‡çŸ­æˆ–ä¸ºç©ºï¼ˆé•¿åº¦: ${text?.length || 0}ï¼‰`);
    }

    btn.textContent = "ğŸ¤– AI åˆ†æä¸­...";

    // ç¬¬äºŒæ­¥ï¼šç»™ AI
    const words = await callGeminiAI(text);

    if (!words || words.length === 0) {
      throw new Error("AI æœªè¿”å›æœ‰æ•ˆç»“æœ");
    }

    // ç¬¬ä¸‰æ­¥ï¼šæ˜¾ç¤º
    renderSidebar(words);
    btn.textContent = "âœ… å®Œæˆ!";

    setTimeout(() => {
      btn.textContent = originalText;
    }, 2000);
  } catch (error) {
    console.error("âŒ å¤„ç†å¤±è´¥:", error);
    btn.textContent = "âŒ å¤±è´¥";

    // ç®€åŒ–é”™è¯¯æç¤º
    alert(`å¤„ç†å¤±è´¥: ${error.message}`);

    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    return;
  }

  btn.disabled = false;
}

// --- 3. è·å–å­—å¹•ï¼ˆå¤šç­–ç•¥ï¼‰---
async function tryGetSubtitles() {
  console.log("ğŸ“¥ å¼€å§‹è·å–å­—å¹•...");

  // ç­–ç•¥1: ä»é¡µé¢ ytInitialPlayerResponse æå–
  try {
    console.log("ğŸ” ç­–ç•¥1: æŸ¥æ‰¾ ytInitialPlayerResponse...");
    const scriptTag = Array.from(document.querySelectorAll("script")).find(
      (s) => s.textContent.includes("ytInitialPlayerResponse"),
    );

    if (scriptTag) {
      console.log("âœ… æ‰¾åˆ°åŒ…å« ytInitialPlayerResponse çš„ script æ ‡ç­¾");
      // å°è¯•å¤šç§åŒ¹é…æ¨¡å¼
      let match = scriptTag.textContent.match(
        /var ytInitialPlayerResponse = ({.+?});/s,
      );
      if (!match) {
        match = scriptTag.textContent.match(
          /ytInitialPlayerResponse\s*=\s*({.+?});/s,
        );
      }
      if (!match) {
        match = scriptTag.textContent.match(
          /ytInitialPlayerResponse"\s*:\s*({.+?}),/s,
        );
      }

      if (match) {
        console.log("âœ… åŒ¹é…åˆ° playerData");
        const playerData = JSON.parse(match[1]);
        const captions =
          playerData?.captions?.playerCaptionsTracklistRenderer?.captionTracks;

        console.log("ğŸ“‹ å­—å¹•è½¨é“æ•°é‡:", captions?.length || 0);
        if (captions && captions.length > 0) {
          const engTrack =
            captions.find((t) => t.languageCode === "en") || captions[0];
          console.log("âœ… æ‰¾åˆ°å­—å¹•è½¨é“:", engTrack.name.simpleText);

          const subUrl = engTrack.baseUrl + "&fmt=json3";
          const rawData = await new Promise((resolve) =>
            chrome.runtime.sendMessage(
              { type: "FETCH_SUBTITLES", url: subUrl },
              resolve,
            ),
          );

          if (rawData?.success && rawData.data) {
            console.log("ğŸ“¦ åŸå§‹å­—å¹•æ•°æ®é•¿åº¦:", rawData.data.length);
            const parsed = JSON.parse(rawData.data);
            const text = parsed.events
              .filter((e) => e.segs)
              .map((e) => e.segs.map((s) => s.utf8).join(""))
              .join(" ")
              .replace(/\n/g, " ")
              .trim();

            console.log("âœ… å­—å¹•æå–æˆåŠŸï¼Œé•¿åº¦:", text.length);
            if (text.length > 100) {
              return text.slice(0, 15000);
            }
          }
        }
      } else {
        console.warn("âš ï¸ æœªåŒ¹é…åˆ° ytInitialPlayerResponse å˜é‡");
      }
    } else {
      console.warn("âš ï¸ æœªæ‰¾åˆ°åŒ…å« ytInitialPlayerResponse çš„ script æ ‡ç­¾");
    }
  } catch (e) {
    console.error("âŒ ç­–ç•¥1å¤±è´¥:", e.message, e.stack);
  }

  // ç­–ç•¥2: ä½¿ç”¨ YouTube Transcript APIï¼ˆé€šè¿‡ backgroundï¼‰
  try {
    const videoId = new URLSearchParams(window.location.search).get("v");
    console.log("ğŸ” ç­–ç•¥2: è§†é¢‘ID =", videoId);
    if (videoId) {
      console.log("ğŸ”„ å°è¯•å¤‡ç”¨å­—å¹•æ¥å£...");
      const transcriptData = await new Promise((resolve) =>
        chrome.runtime.sendMessage(
          {
            type: "FETCH_TRANSCRIPT",
            videoId: videoId,
          },
          resolve,
        ),
      );

      console.log("ğŸ“¦ ç­–ç•¥2è¿”å›æ•°æ®:", transcriptData);
      if (transcriptData?.success && transcriptData.text) {
        console.log("âœ… å¤‡ç”¨æ¥å£æˆåŠŸï¼Œæ–‡æœ¬é•¿åº¦:", transcriptData.text.length);
        if (transcriptData.text.length > 100) {
          return transcriptData.text;
        } else {
          console.warn("âš ï¸ ç­–ç•¥2æ–‡æœ¬å¤ªçŸ­:", transcriptData.text.length);
        }
      } else {
        console.warn("âš ï¸ ç­–ç•¥2æœªè¿”å›æœ‰æ•ˆæ•°æ®:", transcriptData);
      }
    } else {
      console.warn("âš ï¸ æœªæ‰¾åˆ°è§†é¢‘ID");
    }
  } catch (e) {
    console.error("âŒ ç­–ç•¥2å¤±è´¥:", e.message, e.stack);
  }

  // å›é€€: ä½¿ç”¨ç¤ºä¾‹æ–‡æœ¬
  console.log("âš ï¸ æ‰€æœ‰å­—å¹•è·å–å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®");
  return "Joey: How you doin? Rachel: I'm getting cold feet about the wedding. Ross: We were on a break! Phoebe: It is a moo point. Monica: I know! Chandler: Could this BE any more ironic?";
}

// --- 4. å‘¼å« AIï¼ˆæ”¯æŒå­˜å‚¨çš„ API Keyï¼‰---
async function callGeminiAI(text) {
  // ä» Chrome Storage è·å– API Key
  const apiKey = await new Promise((resolve) => {
    chrome.storage.sync.get(["geminiApiKey"], (result) => {
      resolve(result.geminiApiKey || "AIzaSyAYN7e9oTmOEg_gjRarPrscJvpYXZFCjlc");
    });
  });

  if (!apiKey) {
    alert("âš ï¸ è¯·å…ˆåœ¨æ’ä»¶è®¾ç½®ä¸­é…ç½® Gemini API Keyï¼");
    return null;
  }

  // ä½¿ç”¨æœ€æ–°çš„ç¨³å®šæ¨¡å‹ï¼šgemini-1.5-flash æˆ– gemini-1.5-pro
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

  const prompt = `You are an English teacher. Extract 5-8 advanced words or idioms (B2+ level) from the following text. Return ONLY a valid JSON array, no markdown formatting:
[{"word":"phrase here", "definition":"Chinese translation (ä¸­æ–‡é‡Šä¹‰)", "context":"original sentence from text"}]

Text: "${text.slice(0, 8000)}"`;

  // æŒ‰ä¼˜å…ˆçº§å°è¯•å¤šä¸ªæ¨¡å‹ï¼ˆä½¿ç”¨ v1 APIï¼Œä¸æ˜¯ v1betaï¼‰
  const models = ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-pro"];

  for (const model of models) {
    try {
      console.log(`ğŸ¤– å°è¯•æ¨¡å‹: ${model}`);
      // ä½¿ç”¨ v1 API è€Œä¸æ˜¯ v1beta
      const modelUrl = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${apiKey}`;

      const res = await fetch(modelUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 2048,
          },
        }),
      });

      if (!res.ok) {
        const errorText = await res.text();
        console.warn(
          `âš ï¸ æ¨¡å‹ ${model} å¤±è´¥ (${res.status}):`,
          errorText.slice(0, 200),
        );
        continue; // å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
      }

      const data = await res.json();
      if (!data.candidates || !data.candidates[0]) {
        console.warn(`âš ï¸ æ¨¡å‹ ${model} æœªè¿”å›æœ‰æ•ˆç»“æœ`);
        continue;
      }

      const responseText = data.candidates[0].content.parts[0].text;
      console.log(`âœ… æ¨¡å‹ ${model} æˆåŠŸ!`, responseText.slice(0, 100));

      const jsonStr = responseText
        .replace(/```json\n?/g, "")
        .replace(/```\n?/g, "")
        .trim();

      const result = JSON.parse(jsonStr);
      return Array.isArray(result) ? result : [result];
    } catch (e) {
      console.warn(`âš ï¸ æ¨¡å‹ ${model} é”™è¯¯:`, e.message);
      continue; // å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
    }
  }

  // æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥ - ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼
  console.error("âŒ æ‰€æœ‰ AI æ¨¡å‹å‡å¤±è´¥ï¼Œå¯ç”¨æ¼”ç¤ºæ¨¡å¼");

  const useDemoMode = confirm(
    `AI åˆ†æå¤±è´¥: API Key å¯èƒ½æœªé…ç½®æˆ–ä¸å¯ç”¨\n\nç‚¹å‡»ã€ç¡®å®šã€‘ä½¿ç”¨æ¼”ç¤ºæ•°æ®æŸ¥çœ‹åŠŸèƒ½\nç‚¹å‡»ã€å–æ¶ˆã€‘åœæ­¢å¹¶æ£€æŸ¥é…ç½®`,
  );

  if (useDemoMode) {
    console.log("ğŸ­ ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼");
    // è¿”å›æ¼”ç¤ºæ•°æ®
    return [
      {
        word: "cold feet",
        definition: "ä¸´é˜µé€€ç¼©ï¼›ï¼ˆå°¤æŒ‡å©šå‰ï¼‰ç´§å¼ å®³æ€•",
        context: "I'm getting cold feet about the wedding.",
      },
      {
        word: "we were on a break",
        definition: "æˆ‘ä»¬å½“æ—¶åˆ†æ‰‹äº†ï¼ˆç»å…¸å°è¯ï¼‰",
        context: "Ross: We were on a break!",
      },
      {
        word: "moo point",
        definition: "æ— æ„ä¹‰çš„è§‚ç‚¹ï¼ˆPhoebe å¼å¹½é»˜ï¼ŒåŸä¸º moot pointï¼‰",
        context: "It is a moo point.",
      },
      {
        word: "How you doin'?",
        definition: "ä½ å¥½å—ï¼Ÿï¼ˆJoey çš„ç»å…¸æ­è®ªè¯­ï¼‰",
        context: "Joey: How you doin?",
      },
      {
        word: "Could this BE any more...",
        definition: "è¿˜èƒ½æ›´...å—ï¼Ÿï¼ˆChandler çš„ç»å…¸å¥å¼ï¼‰",
        context: "Could this BE any more ironic?",
      },
    ];
  }

  return null;
}

// --- 5. æ˜¾ç¤ºä¾§è¾¹æ  ---
function renderSidebar(data) {
  const existing = document.getElementById("ww-sidebar");
  if (existing) existing.remove();

  const div = document.createElement("div");
  div.id = "ww-sidebar";
  div.style.cssText =
    "position:fixed; top:0; right:0; width:300px; height:100vh; background:#111; color:#fff; padding:20px; z-index:9999; overflow-y:auto; border-left:1px solid #333;";

  div.innerHTML = `<h2 style="color:#3ea6ff">WonderWords</h2><hr style="border-color:#333">`;

  data.forEach((item) => {
    div.innerHTML += `
      <div style="background:#222; padding:10px; margin-bottom:10px; border-radius:5px;">
        <div style="font-weight:bold; color:#fff; font-size:16px;">${item.word}</div>
        <div style="color:#aaa; font-size:14px;">${item.definition}</div>
        <div style="color:#3ea6ff; font-size:12px; margin-top:5px;">"${item.context}"</div>
      </div>
    `;
  });

  const close = document.createElement("button");
  close.innerText = "Close";
  close.style.cssText =
    "margin-top:20px; width:100%; padding:10px; background:#333; color:#fff; border:none; cursor:pointer;";
  close.onclick = () => div.remove();
  div.appendChild(close);

  document.body.appendChild(div);
}
